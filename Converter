function convertToWebP($sourcePath, $destinationPath, $quality = 60) {
    // Get image info
    $imageInfo = getimagesize($sourcePath);
    if ($imageInfo === false) {
        return false;
    }
    
    $sourceImage = null;
    
    // Create image resource based on mime type - supports all major formats
    switch ($imageInfo['mime']) {
        // Standard web formats
        case 'image/jpeg':
        case 'image/jpg':
            $sourceImage = imagecreatefromjpeg($sourcePath);
            break;
        case 'image/png':
            $sourceImage = imagecreatefrompng($sourcePath);
            break;
        case 'image/gif':
            $sourceImage = imagecreatefromgif($sourcePath);
            break;
        case 'image/webp':
            $sourceImage = imagecreatefromwebp($sourcePath);
            break;
            
        // Additional formats supported by GD
        case 'image/bmp':
        case 'image/x-ms-bmp':
            if (function_exists('imagecreatefrombmp')) {
                $sourceImage = imagecreatefrombmp($sourcePath);
            }
            break;
        case 'image/tiff':
            // Note: TIFF support varies by GD version
            if (function_exists('imagecreatefromtiff')) {
                $sourceImage = imagecreatefromtiff($sourcePath);
            }
            break;
        case 'image/x-icon':
        case 'image/vnd.microsoft.icon':
            // ICO files - basic support
            if (function_exists('imagecreatefromico')) {
                $sourceImage = imagecreatefromico($sourcePath);
            }
            break;
        case 'image/avif':
            // AVIF support (newer format)
            if (function_exists('imagecreatefromavif')) {
                $sourceImage = imagecreatefromavif($sourcePath);
            }
            break;
            
        // Raw image formats (if supported)
        case 'image/x-portable-bitmap':
        case 'image/x-portable-graymap':
        case 'image/x-portable-pixmap':
            // PBM/PGM/PPM formats - limited support
            break;
            
        default:
            // Try to handle unknown formats using ImageMagick if available
            if (extension_loaded('imagick')) {
                try {
                    $imagick = new Imagick($sourcePath);
                    $imagick->setImageFormat('webp');
                    $imagick->setImageCompressionQuality($quality);
                    $result = $imagick->writeImage($destinationPath);
                    $imagick->destroy();
                    return $result;
                } catch (Exception $e) {
                    return false;
                }
            }
            return false;
    }
    
    if ($sourceImage === false) {
        return false;
    }
    
    // For PNG images, preserve transparency
    if ($imageInfo['mime'] === 'image/png') {
        // Enable alpha blending and save alpha channel
        imagealphablending($sourceImage, false);
        imagesavealpha($sourceImage, true);
    }
    
    // Convert to WebP with specified quality
    $result = imagewebp($sourceImage, $destinationPath, $quality);
    
    // Clean up memory
    imagedestroy($sourceImage);
    
    return $result;
}

function getSupportedImageFormats() {
    $formats = [];
    
    // Check GD support
    if (function_exists('gd_info')) {
        $gdInfo = gd_info();
        
        if ($gdInfo['JPEG Support']) $formats[] = 'image/jpeg';
        if ($gdInfo['PNG Support']) $formats[] = 'image/png';
        if ($gdInfo['GIF Read Support'] || $gdInfo['GIF Create Support']) $formats[] = 'image/gif';
        if (isset($gdInfo['WebP Support']) && $gdInfo['WebP Support']) $formats[] = 'image/webp';
        if (function_exists('imagecreatefrombmp')) $formats[] = 'image/bmp';
        if (function_exists('imagecreatefromavif')) $formats[] = 'image/avif';
    }
    
    // Check ImageMagick support
    if (extension_loaded('imagick')) {
        $imagick = new Imagick();
        $imagickFormats = $imagick->queryFormats();
        
        $additionalFormats = [
            'TIFF' => 'image/tiff',
            'TIF' => 'image/tiff',
            'ICO' => 'image/x-icon',
            'PSD' => 'image/vnd.adobe.photoshop',
            'SVG' => 'image/svg+xml',
            'RAW' => 'image/x-canon-cr2', // Example RAW format
            // Add more as needed
        ];
        
        foreach ($additionalFormats as $format => $mimeType) {
            if (in_array($format, $imagickFormats)) {
                $formats[] = $mimeType;
            }
        }
    }
    
    return array_unique($formats);
}

function isValidImageFormat($filePath) {
    $imageInfo = getimagesize($filePath);
    if ($imageInfo === false) {
        return false;
    }
    
    $supportedFormats = getSupportedImageFormats();
    return in_array($imageInfo['mime'], $supportedFormats);
}